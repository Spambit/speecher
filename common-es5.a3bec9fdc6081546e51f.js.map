{"version":3,"sources":["webpack:///src/app/services/login.service.ts","webpack:///src/app/utils/object.util.ts","webpack:///src/app/utils/index.ts","webpack:///src/app/services/drive.service.ts","webpack:///src/app/conf/conf.drive.keys.ts"],"names":["LoginService","login$","this","loadGoogleApi","scope","apiKey","clientId","discoveryDocs","gapi","client","init","then","googleAuth","auth2","getAuthInstance","isSignedIn","listen","updateSigninStatus","e","Promise","reject","isLoggedIn","console","log","next","script","document","createElement","addEventListener","googleApiDidLoad","setAttribute","body","appendChild","forScope","currentUser","get","hasGrantedScopes","user","getBasicProfile","avatar","getImageUrl","name","getName","email","getEmail","shortName","getFamilyName","load","msg","error","key","initClient","_","builder","SigninOptionsBuilder","setPrompt","setScope","signIn","throwDeferedError","signOut","createInstanceOfClass","c","attrValues","obj","Object","keys","defer","fn","window","setTimeout","DriveService","loginService","loginOptions","loadGoogleDrive","createFolderInternal","id","drive","files","list","q","fields","spaces","res","status","resolve","loadApi","login","pipe","first","subscribe","loggedIn","fileMetadata","mimeType","folderColorRgb","create","resource","response","file","result","logout","folderId","withContent","createFileWithJSONContent","data","JSON","stringify","delimiter","multipartRequestBody","parents","request","path","method","params","uploadType","headers","execute"],"mappings":"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","file":"x","sourcesContent":["import * as Utils from '../utils';\nimport { Injectable } from '@angular/core';\nimport { Observable, Subject, of } from 'rxjs';\n\ndeclare var gapi: any;\n\n@Injectable({ providedIn: 'root' })\nexport class LoginService {\n  readonly login$: Subject<boolean> = new Subject();\n  private googleAuth: any;\n  constructor() {\n    this.loadGoogleApi();\n  }\n\n  private initClient({\n    scope = '',\n    apiKey = '',\n    clientId = '',\n    discoveryDocs = ([] = ['']),\n  }): Promise<any> {\n    if (!gapi) {\n      return Promise.reject('Google Api not available.');\n    }\n\n    return gapi.client\n      .init({\n        apiKey,\n        clientId,\n        scope,\n        discoveryDocs,\n      })\n      .then(\n        () => {\n          this.googleAuth = gapi.auth2.getAuthInstance();\n          // Listen for sign-in state changes.\n          this.googleAuth.isSignedIn.listen((isSignedIn) =>\n            this.updateSigninStatus(isSignedIn)\n          );\n        },\n        (e) => Promise.reject(e)\n      );\n  }\n\n  private updateSigninStatus(isLoggedIn: boolean) {\n    console.log(`Logged in : ${isLoggedIn}`);\n    this.login$.next(isLoggedIn);\n  }\n\n  private loadGoogleApi() {\n    const gapiUrl = 'https://apis.google.com/js/api.js';\n    const script = document.createElement('script');\n    script.addEventListener('load', () => this.googleApiDidLoad());\n    script.setAttribute('src', gapiUrl);\n    document.body.appendChild(script);\n  }\n\n  isLoggedIn({ forScope = '' }): boolean {\n    if (!this.googleAuth) {\n      return false;\n    }\n    const user = this.googleAuth.currentUser.get();\n    return user.hasGrantedScopes(forScope);\n  }\n\n  getUserInfo(): { avatar: string, name: string, email: string, shortName: string } {\n    if (!this.googleAuth || !this.googleAuth.currentUser) {\n      return;\n    }\n    const user = this.googleAuth.currentUser.get().getBasicProfile();\n    return {\n      avatar: user.getImageUrl(),\n      name: user.getName(),\n      email: user.getEmail(),\n      shortName: user.getFamilyName()\n    };\n  }\n\n  private googleApiDidLoad() {\n    gapi.load('client:auth2', () => {\n      console.log('Google auth loaded.');\n    });\n  }\n\n  private throwDeferedError(msg: string): void {\n    Utils.defer(() => {\n      this.login$.error(msg);\n    });\n  }\n\n  public login({\n    scope = '',\n    key = '',\n    clientId = '',\n    discoveryDocs = ([] = ['']),\n  }): Observable<boolean> {\n    this.initClient({ scope, apiKey: key, clientId, discoveryDocs })\n      .then((_) => {\n        if (this.googleAuth.isSignedIn.get()) {\n          this.login$.next(true);\n        } else {\n          const builder = new gapi.auth2.SigninOptionsBuilder();\n          builder.setPrompt('select_account');\n          builder.setScope('profile').setScope('email');\n          this.googleAuth.signIn(builder).catch((e) => {\n            this.throwDeferedError(e);\n          });\n        }\n      })\n      .catch((e) => {\n        this.login$.error(e);\n      });\n    return this.login$;\n  }\n  public logout(): Observable<boolean> {\n    if (!this.googleAuth) {\n      this.throwDeferedError('Google Auth was not loaded.');\n    } else if (!this.googleAuth.isSignedIn.get()) {\n      Utils.defer(() => this.login$.next(false));\n    } else {\n      this.googleAuth.signOut().catch((e) => {\n        this.throwDeferedError('logout failed');\n      });\n    }\n    return this.login$;\n  }\n}\n","export function createInstanceOfClass<T>(c: new () => T, attrValues: any): T {\n  const obj = new c();\n  const keys = Object.keys(attrValues);\n  for (const key of keys) {\n    obj[key] = attrValues[key];\n  }\n  return obj;\n}\n\nexport function clone<T>(obj: T): T {\n  const cloneObj = new (this.constructor() as any)();\n  for (const attr in obj) {\n    if (typeof obj[attr] === 'object') {\n      cloneObj[attr] = clone(obj[attr]);\n    } else {\n      cloneObj[attr] = obj[attr];\n    }\n  }\n  return cloneObj;\n}\n\nexport function setProperty<T, K extends keyof T>(obj: T, key: K, val: any) {\n  return (obj[key] = val);\n}\n\nexport function getProperty<T, K extends keyof T>(obj: T, key: K) {\n  return obj[key];\n}\n\nexport function create<T>(c: new () => T): T {\n  return new c();\n}\n","export * from './object.util';\n\nexport type anyfn = (...args: any[]) => any;\nexport const defer = (fn: anyfn) => {\n  window.setTimeout(fn, 0);\n};\n","import { Injectable } from '@angular/core';\nimport { LoginService } from './login.service';\nimport { first } from 'rxjs/operators';\nimport { environment } from '../environments/env';\nimport { Observable } from 'rxjs';\nimport { rejects } from 'assert';\n\ndeclare var gapi: any;\n\n@Injectable({ providedIn: 'root' })\nexport class DriveService {\n  private loginOptions = {\n    key: environment.drive_api_key,\n    clientId: environment.drive_client_id,\n    scope: 'https://www.googleapis.com/auth/drive.appdata',\n    discoveryDocs: [\n      'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',\n    ],\n  };\n  constructor(private loginService: LoginService) {}\n  createBaseFolder(name?: string): Promise<{ id?: string }> {\n    return this.loadGoogleDrive().then(() =>\n      this.createFolderInternal({ name })\n    );\n  }\n\n  isLoggedIn() {\n    return this.loginService.isLoggedIn({ forScope: this.loginOptions.scope });\n  }\n\n  findFile({ id }: { id: string }): Promise<boolean> {\n    return this.loadGoogleDrive().then(() => {\n      return gapi.client.drive.files\n        .list({\n          // tslint:disable-next-line: quotemark\n          q: `'${id}' in parents`,\n          fields: 'nextPageToken, files(id, name)',\n          spaces: 'drive'\n        })\n        .then((res) => (res.status === 200 ? true : false))\n        .catch(() => false);\n    });\n  }\n\n  login(): Promise<void>{\n    return this.loadGoogleDrive();\n  }\n\n  private loadGoogleDrive(): Promise<void> {\n    return new Promise((resolve, reject) => {\n      if (\n        !this.loginService.isLoggedIn({ forScope: this.loginOptions.scope })\n      ) {\n        this.loginService\n          .login(this.loginOptions)\n          .pipe(first())\n          .subscribe((loggedIn) => {\n            if (loggedIn) {\n              this.loadApi().then(resolve).catch(reject);\n            } else {\n              reject();\n            }\n          });\n        return;\n      }\n      this.loadApi().then(resolve).catch(reject);\n    });\n  }\n\n  private loadApi(): Promise<void> {\n    if (gapi && gapi.client.drive) {\n      return Promise.resolve();\n    }\n    return gapi.client.load('drive', 'v3');\n  }\n\n  private createFolderInternal({\n    name = 'Speecher-Data-Folder',\n  }): Promise<{ id?: string }> {\n    const fileMetadata = {\n      name,\n      mimeType: 'application/vnd.google-apps.folder',\n      folderColorRgb: '#007bff',\n    };\n    console.log('Logged in and trying to create folder in drive.');\n    return new Promise((resolve, reject) => {\n      const options = {\n        resource: fileMetadata,\n        fields: 'id',\n      };\n      gapi.client.drive.files.create(options).then((response) => {\n        switch (response.status) {\n          case 200:\n            const file = response.result;\n            console.log('Created file or folder Id: ', file.id);\n            resolve({ id: file.id });\n            break;\n          default:\n            console.log('Error creating the file or folder, ' + response);\n            reject(response);\n            break;\n        }\n      });\n    });\n  }\n\n  logout(): Observable<boolean> {\n    return this.loginService.logout();\n  }\n\n  createFile({ name, withContent, folderId }: {name: string, withContent: any, folderId: string}): Promise<void> {\n    return this.createFileWithJSONContent({name, data : JSON.stringify(withContent), folderId});\n  }\n\n  private createFileWithJSONContent({ name, data, folderId }: {name: string, data: string, folderId: string}): Promise<void> {\n    return new Promise((resolve, reject) => {\n      const boundary = '-------speecher-boundary';\n      const delimiter = '\\r\\n--' + boundary + '\\r\\n';\n      const closeDelim = '\\r\\n--' + boundary + '--';\n\n      const contentType = 'application/json';\n\n      const metadata = {\n        name,\n        mimeType: contentType,\n        parents: [folderId]\n      };\n\n      const multipartRequestBody =\n        delimiter +\n        'Content-Type: application/json\\r\\n\\r\\n' +\n        JSON.stringify(metadata) +\n        delimiter +\n        'Content-Type: ' +\n        contentType +\n        '\\r\\n\\r\\n' +\n        data +\n        closeDelim;\n\n      const request = gapi.client.request({\n        path: '/upload/drive/v3/files',\n        method: 'POST',\n        params: { uploadType: 'multipart' },\n        headers: {\n          'Content-Type': 'multipart/related; boundary=\"' + boundary + '\"',\n        },\n        body: multipartRequestBody,\n      });\n      request.execute((_ , res) => {\n        if (res.status !== 200) {\n          return reject();\n        }\n        resolve();\n      });\n    });\n  }\n}\n","export const drive = {\n  key: 'AIzaSyDoqtuscz4Pp_xuR9nYO10O-PsouptHmuA',\n  clientId: '814240394039-953g9k1ovucedj8u0aghsj5ofsii5jut.apps.googleusercontent.com'\n};\n"]}